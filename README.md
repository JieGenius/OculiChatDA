# OculiChatDA çœ¼ç§‘é—®è¯Šå¤§æ¨¡å‹

<!-- PROJECT SHIELDS -->

<!--
[![Contributors][contributors-shield]][contributors-url]
[![Forks][forks-shield]][forks-url]
[![Issues][issues-shield]][issues-url]
[![MIT License][license-shield]][license-url]
[![Stargazers][stars-shield]][stars-url]
-->

<br />
<!-- PROJECT LOGO -->

<p align="center">
  <a href="https://github.com/JieGenius/OculiChatDA/">
    <img src="assets/logo.png" alt="Logo" width="60%">
  </a>

<h3 align="center">OculiChatDA</h3>
  <p align="center">
    <br />
    <a href="https://openxlab.org.cn/apps/detail/flyer/oculi_chat_diagnosis_assistant"> OpenXLab ä½“éªŒ</a>
    Â·
    <a href="https://github.com/JieGenius/OculiChatDA/issues">æŠ¥å‘ŠBug & æå‡ºæ–°ç‰¹æ€§</a>
  </p>
</p>

ğŸ‰æ›´æ–°

- \[2024/03/15\] å°†ç—…ç§æ•°é‡æå‡è‡³4ï¼Œæ¨¡å‹è®­ç»ƒæ—¶åšäº†æ•°æ®æ¸…æ´—å¹¶ä½¿ç”¨äº†msagentçš„éƒ¨åˆ†æ•°æ®ä»¥æé«˜å·¥å…·è°ƒç”¨èƒ½åŠ›
- ã€2024/02/20\] Lagentç‰ˆæœ¬æ”¯æŒ0.2.2

## ç®€ä»‹

</br>

**OculiChatDA** æ˜¯ä¸€ä¸ªçœ¼ç§‘é—®è¯Šçš„å¤§æ¨¡å‹ï¼Œç”¨æˆ·å¯ä»¥å¯¹çœ¼ç›ç›¸å…³çš„ç–¾ç—…è¿›è¡Œé—®è¯Šï¼Œè·å–ä¸“ä¸šçš„åŒ»å­¦å»ºè®®ã€‚åŒæ—¶æ¨¡å‹æ‹¥æœ‰è¯»å›¾çš„èƒ½åŠ›ï¼Œå¯é€šè¿‡çœ¼åº•å›¾åˆ¤æ–­æ˜¯å¦ä¸º**é’å…‰çœ¼æˆ–ç³–å°¿ç—…è§†ç½‘è†œç—…å˜**æ‚£è€…ã€‚
OculiChatDAçš„é—®è¯Šæ•°æ®é›†åŒ…å«äº†çœ¼ç§‘é—®è¯Šçš„å¸¸è§é—®é¢˜ï¼Œå¯ä»¥è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œæ”¯æŒå¤šç§å¯¹è¯åœºæ™¯ï¼ŒåŒ…æ‹¬é—®è¯Šã€å’¨è¯¢ã€é—²èŠç­‰ã€‚

å¼€æºä¸æ˜“ï¼Œå¦‚æœæœ¬é¡¹ç›®å¸®åˆ°å¤§å®¶ï¼Œå¯ä»¥å³ä¸Šè§’å¸®æˆ‘ç‚¹ä¸ª star~ â­â­ , æ‚¨çš„ star â­æ˜¯æˆ‘ä»¬æœ€å¤§çš„é¼“åŠ±ï¼Œè°¢è°¢å„ä½ï¼

åœ¨æ­¤ç‰¹åˆ«æ„Ÿè°¢:
ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤æä¾›çš„ç®—åŠ›æ”¯æŒï¼Œè¯¾ç¨‹æŒ‡å¯¼ä»¥åŠ[OpenXLab](https://openxlab.org.cn/)æä¾›çš„å¹³å°æ”¯æŒï¼Œè®©æˆ‘ä»¬å¯ä»¥å°†æ¨¡å‹éƒ¨ç½²åˆ°çº¿ä¸Šï¼Œä¸ºæ›´å¤šçš„äººæä¾›æœåŠ¡ã€‚
æ„Ÿè°¢æµ¦è¯­å°åŠ©æ‰‹çš„æ— ç§å¥‰çŒ®å’Œæ”¯æŒã€‚

## ä»‹ç»

æ®ä¼°ç®—ï¼Œä¸­å›½çš„åŒ»ç”Ÿå’Œæ‚£è€…æ¯”ä¾‹ä»…ä¸ºè¥¿æ–¹å›½å®¶çš„1/6ã€‚å°½ç®¡å›½å®¶åœ¨åŒ»ç–—å«ç”Ÿäº‹ä¸šæŠ•å…¥ä¸æ–­å¢åŠ ï¼ŒåŒ»é™¢æ•°é‡å’Œè§„æ¨¡ä¹Ÿå¤§å¹…æå‡ï¼Œä½†åŒ»ç”Ÿæ•°é‡å’Œè´¨é‡ä»ç„¶å­˜åœ¨ç“¶é¢ˆã€‚ä¸æ­¤åŒæ—¶ï¼ŒåŸä¹¡åŒ»ç–—èµ„æºçš„ä¸å‡è¡¡åˆ†å¸ƒç»™å†œæ‘å’Œåè¿œåœ°åŒºçš„å±…æ°‘å¸¦æ¥äº†æå¤§çš„å°±åŒ»ä¸ä¾¿ã€‚

æœ¬é¡¹ç›®åŸºäºä»¥ä¸Šç°çŠ¶ï¼Œè®¾è®¡äº†ä¸€æ¬¾ä½æˆæœ¬ï¼Œå…ˆè¿›çš„å¯¹è¯é—®è¯Šç³»ç»Ÿï¼Œé€šè¿‡å¯¹è¯çš„æ–¹å¼ï¼Œå¸®åŠ©æ‚£è€…è¿…é€Ÿè¿›è¡Œåˆæ­¥çš„è¯Šæ–­ï¼Œå¹¶ä¸”ç»™å‡ºåˆç†çš„å»ºè®®ï¼ŒåŒæ—¶ï¼Œè¯¥æ¨¡å‹å·²ç»åˆæ­¥å…·æœ‰â€œæœ›é—»é—®åˆ‡â€çš„ä¸€åŠèƒ½åŠ›ï¼Œå³**æœ›**å’Œ**é—®**ã€‚è¿™ä¸€ä½æˆæœ¬ã€é«˜æ•ˆç‡çš„è§£å†³æ–¹æ¡ˆè‡´åŠ›äºå¡«è¡¥åŒ»ç–—èµ„æºä¸è¶³çš„ç©ºç¼ºï¼Œä¸ºæ›´å¤šæ‚£è€…æä¾›åŠæ—¶ã€ä¾¿æ·çš„åŒ»ç–—æœåŠ¡ã€‚

## æ¼”ç¤º

**Demoè®¿é—®åœ°å€:** [OculiChatDA](https://openxlab.org.cn/apps/detail/flyer/oculi_chat_diagnosis_assistant)

**æ•ˆæœå±•ç¤º:**
![å®£ä¼ å›¾](assets/publicity.png)

## æ¨¡å‹

| æ¨¡å‹                  | åŸºåº§                | æ•°æ®é‡    | OpenXLab
|---------------------|-------------------|--------|----------------------------------------------------------------------------------------|
| OculiChatDA-chat-7b | InternLM2-chat-7b | 60Kä¸ªå¯¹è¯ | [![Open in OpenXLab](https://cdn-static.openxlab.org.cn/header/openxlab_models.svg)](https://openxlab.org.cn/models/detail/flyer/OculiChatDA/tree/v1) |

## ç¯å¢ƒå®‰è£…

```bash
conda create -n OculiChatDA python=3.10 # ä¸å»ºè®®å®‰è£…3.11ä»¥åŠä»¥ä¸Šç‰ˆæœ¬, xtuneræœ€æ–°ç‰ˆåªæ”¯æŒ3.8~3.10
conda activate OculiChatDA
pip install -r requirements.txt
```

## æ•°æ®é›†

### é—®è¯Šæ•°æ®é›†

1. çœ¼ç§‘ä¸“ä¸šä¹¦ç±
2. çœ¼ç§‘ä¹ é¢˜
3. ä¸­åŒ»çœ¼ç§‘
4. [MedDialogæ•°æ®é›†](https://github.com/UCSD-AI4H/Medical-Dialogue-System)

æ ·ä¾‹å¦‚ä¸‹:

```json
{
  "conversation": [
    {
      "system": "ä½ æ˜¯ä¸€åçœ¼ç§‘ä¸“å®¶ï¼Œä½ éœ€è¦è§£ç­”æ‚£è€…çš„ç–‘é—®ï¼Œæä¾›å‡†ç¡®çš„å›ç­”ï¼Œå¿…è¦æ—¶ï¼Œæé†’æ‚£è€…åŠæ—¶æŒ‚å·å°±åŒ»ã€‚\nå½“æ‚£è€…å¯¹ç—‡çŠ¶æè¿°ä¸æ¸…æ—¶ï¼Œä½ éœ€è¦å¾ªåºæ¸è¿›çš„å¼•å¯¼æ‚£è€…ï¼Œè¯¢é—®æ‚£è€…çš„ç—‡çŠ¶ï¼Œä»¥ä¾¿ç»™å‡ºå‡†ç¡®çš„è¯Šæ–­ã€‚\nå½“æ‚£è€…ä¸Šä¼ çœ¼åº•å›¾æ—¶ï¼Œä½ éœ€è°ƒç”¨Agentåˆ¤æ–­çœ¼åº•å›¾ä¸­æ˜¯å¦å­˜åœ¨é’å…‰çœ¼å’Œç³–å°¿ç—…è§†ç½‘è†œç—…å˜ï¼Œè‹¥å­˜åœ¨ï¼Œéœ€è¦æé†’æ‚£è€…åŠæ—¶å°±åŒ»ã€‚\n",
      "input": "ä»€ä¹ˆæ˜¯å•çº¯ç–¤ç–¹ç—…æ¯’æ€§è§’è†œç‚ï¼Ÿ",
      "output": "å•çº¯ç–¤ç–¹ç—…æ¯’æ€§è§’è†œç‚æ˜¯ç”±å•çº¯ç–¤ç–¹ç—…æ¯’ï¼ˆHSVï¼‰å¼•èµ·çš„è§’è†œæ„ŸæŸ“ï¼Œæ˜¯ä¸€ç§å¸¸è§çš„çœ¼éƒ¨ç–¾ç—…ï¼Œä¹Ÿæ˜¯è‡´ç›²æ€§è§’è†œç—…çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯åå¤å‘ä½œï¼Œå¤šæ¬¡å‘ä½œä¼šå¯¼è‡´è§’è†œé€æ¸æ··æµŠå¹¶æœ€ç»ˆå¯èƒ½å¯¼è‡´å¤±æ˜ã€‚"
    }
  ]
}

```

## æ•°æ®æ¸…æ´—è¯´æ˜

å¯¹äºMedDialogæ•°æ®é›†ï¼Œ æˆ‘ä»¬é¦–å…ˆé€šè¿‡å…³é”®å­—ç­›é€‰å’Œçœ¼ç§‘ç›¸å…³çš„å¯¹è¯æ•°æ®ï¼Œç„¶åä½¿ç”¨ "InternLM2-chat-20b-4bits" å¤§æ¨¡å‹æ¥åˆ¤æ–­æ•°æ®è´¨é‡ï¼Œä¸çœ¼ç§‘çš„ç›¸å…³åº¦ã€‚ï¼ˆä»…ä¿ç•™äº†1/6çš„æ•°æ®ï¼‰
å…¶ä»–æ•°æ®é›†ï¼Œåœ¨æˆ‘ä»¬æœ€æ–°çš„è®­ç»ƒä¸­å¹¶æœªä½¿ç”¨ã€‚æˆ‘ä»¬ä¼šåœ¨å°†æ¥é€šè¿‡RAGçš„æ–¹å¼åµŒå…¥åˆ°æˆ‘ä»¬çš„åº”ç”¨ä¸­ï¼Œä¸å†å°†å…¶ç”¨äºå¾®è°ƒå¤§æ¨¡å‹ã€‚

ä¸ºäº†ä¿æŒå¤§æ¨¡å‹å·¥å…·è°ƒç”¨çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬ä¹Ÿæ·»åŠ äº†ä¸€äº›msagentçš„æ•°æ®ï¼Œ
ç›¸å…³ä»£ç è§ [tools/data_prepare/data_clean.py](tools/data_prepare/data_clean.py) ä»¥åŠ [tools/data_prepare/merge_msagent.py](tools/data_prepare/merge_msagent.py)

## å¾®è°ƒ

```bash
mkdir -p /root/OculiChatDA/data
ln -s /share/model_repos/internlm2-chat-7b /root/OculiChatDA/data
xtuner list-cfg
mkdir config
xtuner copy-cfg internlm2_chat_7b_qlora_oasst1_e3 config/internlm2_chat_7b_qlora_oasst1_e3.py
cd config
mv internlm2_chat_7b_qlora_oasst1_e3_copy.py  internlm2_chat_7b_qlora_med_dialog_e3_copy.py
vim internlm2_chat_7b_qlora_med_dialog_e5.py # ä¿®æ”¹é…ç½®æ–‡ä»¶
---> pretrained_model_name_or_path=data/interlm2-chat-7b
---> max_epochs = 5
---> data_path = "./data/qa_data.json"
---> batch_size = 4
---> lr = 1e-5
---> evaluation_inputs = evaluation_inputs = ['é’å…‰çœ¼è¯Šæ–­çš„ä¸‰è¦ç´ æ˜¯ä»€ä¹ˆï¼Ÿ', 'ç³–å°¿ç—…å’Œç³–å°¿ç—…è§†ç½‘è†œç—…å˜æœ‰ä»€ä¹ˆå…³ç³»å‘¢', "åŒ»ç”Ÿä½ å¥½ï¼Œæˆ‘çš„è§†é‡ä¸­å¿ƒæœ‰é»‘è‰²é˜´å½±ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?"]
---> dataset=dict(type=load_dataset, path="json", data_files=dict(train=data_path)),
---> dataset_map_fn = None

xtuner train config/internlm2_chat_7b_qlora_med_dialog_e5_copy.py --deepspeed deepspeed_zero2
# å®æµ‹batchä¸º4è€—æ˜¾å­˜26Gï¼Œéœ€è¦å¼€ä¸€ä¸ª2 * 1/4çš„æœºå™¨
```

## åˆæ­¥æ€§èƒ½æµ‹è¯•

```bash
xtuner convert pth_to_hf config/internlm2_chat_7b_qlora_med_dialog_e3_copy.py work_dirs/internlm2_chat_7b_qlora_med_dialog_e3_copy/epoch_1.pth  ./hf
xtuner convert merge ./data/internlm2-chat-7b ./hf ./merged --max-shard-size 2GB
xtuner chat ./merged --prompt-template internlm2_chat
è¾“å…¥:ä½ æ˜¯è°?
```

## Agentè°ƒç”¨èƒ½åŠ›

è¾“å…¥:

````
#############################################
ä½ æ˜¯ä¸€ä¸ªå¯ä»¥è°ƒç”¨å¤–éƒ¨å·¥å…·çš„åŠ©æ‰‹ï¼Œå¯ä»¥ä½¿ç”¨çš„å·¥å…·åŒ…æ‹¬ï¼š
{'FundusDiagnosis': 'ä¸€ä¸ªçœ¼åº•å›¾åƒè¯Šæ–­çš„å·¥å…·ï¼Œ\nå¯ä»¥è¯Šæ–­çœ¼åº•å›¾åƒä¸­çš„ç—…å˜ç±»å‹ï¼Œå¦‚é’å…‰çœ¼ã€æ˜¯å¦ä¸ºç³–å°¿ç—…è§†ç½‘è†œç—…å˜ã€‚\nè¾“å…¥ä¸ºçœ¼åº•å›¾çš„å›¾åƒè·¯å¾„ï¼Œå¯ä»¥ä¸ºæœ¬åœ°åœ°å€ï¼Œä¹Ÿå¯ä»¥ä¸ºç½‘ç»œåœ°å€(é“¾æ¥)\n'}
å¦‚æœä½¿ç”¨å·¥å…·è¯·éµå¾ªä»¥ä¸‹æ ¼å¼å›å¤ï¼š
```
Thought:æ€è€ƒä½ å½“å‰æ­¥éª¤éœ€è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œæ˜¯å¦éœ€è¦ä½¿ç”¨å·¥å…·
Action:å·¥å…·åç§°ï¼Œä½ çš„å·¥å…·å¿…é¡»ä» [['FundusDiagnosis']] é€‰æ‹©
Action Input:å·¥å…·è¾“å…¥å‚æ•°
```
å·¥å…·è¿”å›æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å›å¤ï¼š
```
Response:è°ƒç”¨å·¥å…·åçš„ç»“æœ
```
å¦‚æœä½ å·²ç»çŸ¥é“äº†ç­”æ¡ˆï¼Œæˆ–è€…ä½ ä¸éœ€è¦å·¥å…·ï¼Œè¯·éµå¾ªä»¥ä¸‹æ ¼å¼å›å¤
```
Thought:ç»™å‡ºæœ€ç»ˆç­”æ¡ˆçš„æ€è€ƒè¿‡ç¨‹
Final Answer:æœ€ç»ˆç­”æ¡ˆ
```
å¼€å§‹
````

ç»§ç»­è¾“å…¥:

```
æˆ‘ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡ï¼Œå›¾ç‰‡è·¯å¾„ä¸º/a/b/c.jpg qè¯·åˆ¤æ–­æˆ‘æ˜¯å¦æ‚£æœ‰é’å…‰çœ¼
```

æ¨¡å‹è¾“å‡º:

```
Thought: ä½ å¥½ï¼æ ¹æ®ä½ çš„æè¿°ï¼Œä½ ä¸Šä¼ äº†ä¸€å¼ çœ¼åº•å›¾åƒï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦æ‚£æœ‰é’å…‰çœ¼ã€‚è¯·é—®ä½ çš„çœ¼åº•å›¾åƒæ˜¯ä»€ä¹ˆç±»å‹çš„ï¼Ÿæ˜¯å½©è‰²è¿˜æ˜¯é»‘ç™½ï¼Ÿæ˜¯æ•°ç çš„è¿˜æ˜¯èƒ¶ç‰‡çš„ï¼Ÿå¦å¤–ï¼Œä½ çš„çœ¼åº•å›¾åƒæ˜¯å¦æœ‰ç—…å˜ï¼Ÿå¦‚æœæœ‰ç—…å˜ï¼Œæ˜¯ä»€ä¹ˆç±»å‹çš„ï¼Ÿè¯·æä¾›æ›´å¤šçš„ä¿¡æ¯ï¼Œä»¥ä¾¿æˆ‘æ›´å¥½åœ°å¸®åŠ©ä½ ã€‚
Action: FundusDiagnosis
Action Input: {"image_path": "/a/b/c.jpg"}<|im_end|>
```

ç”±æ­¤å¯ç¡®å®šå¾®è°ƒåçš„æ¨¡å‹æ²¡æœ‰é—å¿˜Agentè°ƒç”¨çš„èƒ½åŠ›ã€‚

## æ¨¡å‹èƒ½åŠ›æµ‹è¯•:

## lmdeployéƒ¨ç½²

```bash
lmdeploy convert internlm2-chat-7b  ./merged
lmdeploy serve api_server ./workspace --server-name 0.0.0.0 --server-port 23333 --tp 1
```

## å·¥å…·è°ƒç”¨èƒ½åŠ›åŠ å¼º

```bash
# ä½¿ç”¨æœ€æ–°çš„æ¨¡å‹å¼€å§‹å¾®è°ƒ
xtuner copy-cfg internlm2_7b_qlora_msagent_react_e3_gpu8 config
cd config
mv internlm2_7b_qlora_msagent_react_e3_gpu8_copy.py internlm2_7b_qlora_msagent_react_e1.py
vim internlm2_7b_qlora_msagent_react_e1.py
>>> pretrained_model_name_or_path = './merged'
>>> lr = 2e-5
>>> max_epochs = 1

xtuner train config/internlm2_7b_qlora_msagent_react_e1.py --deepspeed deepspeed_zero2
```

## æ¨¡å‹ä¸Šä¼ 

```bash
python model_upload/convert.py
openxlab login
cd merged
openxlab model create --model-repo='flyer/OculiChatDA' -s ./metafile.yml

```

## Web Demo

```bash
streamlit run web_demo.py --server.address=0.0.0.0 --server.port 7860 --server.enableStaticServing True
```

## é’å…‰çœ¼åˆ†ç±»å’Œç³–å°¿ç—…è§†ç½‘è†œç—…å˜åˆ†çº§æ¨¡å‹

è¯¦è§ï¼š [https://github.com/JieGenius/OculiChatDA/blob/main/utils/actions/fundus_diagnosis.py](https://github.com/JieGenius/OculiChatDA/blob/main/utils/actions/fundus_diagnosis.py)

## TODO

- [ ] å·¥å…·è°ƒç”¨èƒ½åŠ›å¾®è°ƒã€‚ ï¼ˆç›®å‰é€šè¿‡æ‰“äº†å¤šä¸ªè¡¥ä¸ï¼Œä¸´æ—¶è§£å†³é‡å¤è°ƒç”¨ï¼Œå‚æ•°é”™è¯¯è°ƒç”¨çš„é—®é¢˜ï¼Œï¼‰
- [ ] è¯­éŸ³é—®è¯Š
- [ ] è§†é¢‘é—®è¯Šï¼Œæ•°å­—äººæ¥å…¥ã€‚
- [ ] é—®è¯Šæ•°æ®é›†æ‰©å……ï¼Œå¢åŠ æ›´å¤šçœŸå®çš„é—®è¯Šæ•°æ®
- [ ] Agentèƒ½åŠ›æ‰©å……ï¼Œè¯†åˆ«æ›´å¤šçš„çœ¼ç—…ï¼ˆå¦‚ä¸­å¿ƒæ€§æµ†æ¶²ï¼Œç—…ç†æ€§è¿‘è§†ï¼Œè§†ç½‘è†œè„±ç¦»ç­‰ï¼‰ï¼Œæ›´å¤šçš„æ¨¡æ€ï¼ˆå¦‚OCTï¼Œè£‚éš™ç¯ï¼Œçœ¼è¡¨ç…§ç›¸ç­‰ï¼‰ï¼Œ
